<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>Mercado Livre - Login e Gerenciamento</title>
    <style>
      /* Reset básico */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(to right, #007acc, #00c6ff);
        color: #333;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      header {
        width: 100%;
        padding: 1rem;
        text-align: center;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      header h1 {
        color: #007acc;
      }
      .container {
        background: #fff;
        width: 90%;
        max-width: 600px;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .btn {
        display: inline-block;
        background: #007acc;
        color: #fff;
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s ease;
        text-decoration: none;
      }
      .btn:hover {
        background: #005fa3;
      }
      .hidden {
        display: none;
      }
      .message {
        margin: 1rem 0;
        padding: 0.75rem;
        border-radius: 4px;
        background-color: #e7f4e4;
        border: 1px solid #a7d7a7;
        color: #2e7d32;
      }
      .error {
        background-color: #f9d6d5;
        border: 1px solid #f08080;
        color: #c62828;
      }
      footer {
        margin-top: 2rem;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Mercado Livre OAuth Login</h1>
    </header>
    <div class="container">
      <div id="message" class="message hidden"></div>
      <!-- Botão de Login -->
      <button id="btnLogin" class="btn">Login com Mercado Livre</button>
      <!-- Seção para autenticação manual -->
      <div id="authCodeSection" class="hidden">
        <p>Se o redirecionamento não funcionar, cole o código de autorização:</p>
        <input
          type="text"
          id="authCodeInput"
          placeholder="Código de autorização"
          style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;"
        />
        <button id="btnTrocar" class="btn">Trocar Código por Token</button>
      </div>
      <!-- Área de status do login -->
      <div id="loginStatus" class="hidden" style="margin-top: 1rem;">
        <p><strong>Logado com sucesso!</strong></p>
        <p id="userData"></p>
      </div>
    </div>
    <footer>
      <p>© 2025 Mercado Livre Integration Demo</p>
    </footer>
    <script>
      // Configurações de OAuth e API
      const CLIENT_ID = "SEU_CLIENT_ID";       // Substitua pelo seu Client ID
      const CLIENT_SECRET = "SEU_CLIENT_SECRET"; // Substitua pelo seu Client Secret (NÃO use isso em produção no browser)
      const REDIRECT_URI = window.location.origin; // Use a própria URL para capturar o código
      const AUTHORIZATION_URL = "https://auth.mercadolivre.com.br/authorization";
      const TOKEN_URL = "https://api.mercadolibre.com/oauth/token";

      let ACCESS_TOKEN = "";
      let SELLER_ID = "";

      // Exibe mensagens de status para o usuário
      function showMessage(msg, isError = false) {
        const messageDiv = document.getElementById("message");
        messageDiv.innerText = msg;
        messageDiv.className = isError ? "message error" : "message";
        messageDiv.classList.remove("hidden");
      }

      // Inicia o fluxo OAuth abrindo uma nova janela para login
      function iniciarAutenticacao() {
        // Constrói a URL de autorização com os parâmetros
        const params = new URLSearchParams({
          response_type: "code",
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI,
        });
        const authUrl = `${AUTHORIZATION_URL}?${params.toString()}`;
        // Abre a URL em uma nova janela
        window.open(authUrl, "_blank");
        showMessage(
          "Abra a janela de login, autorize e depois cole o código na área abaixo se não for redirecionado automaticamente."
        );
        document.getElementById("authCodeSection").classList.remove("hidden");
      }

      // Troca o código de autorização por um token de acesso
      function trocarCodigoPorToken(codigo) {
        const payload = new URLSearchParams({
          grant_type: "authorization_code",
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET,
          code: codigo,
          redirect_uri: REDIRECT_URI,
        });

        fetch(TOKEN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: payload.toString(),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.access_token) {
              ACCESS_TOKEN = data.access_token;
              SELLER_ID = data.user_id;
              showMessage("Autenticação realizada com sucesso!");
              document.getElementById("authCodeSection").classList.add("hidden");
              document.getElementById("btnLogin").classList.add("hidden");
              // Mostra os dados do usuário logado na interface
              document.getElementById("loginStatus").classList.remove("hidden");
              document.getElementById(
                "userData"
              ).innerText = `Access Token: ${ACCESS_TOKEN} | Seller ID: ${SELLER_ID}`;
            } else {
              showMessage("Erro na troca de código por token: " + JSON.stringify(data), true);
            }
          })
          .catch((error) => {
            showMessage("Erro: " + error, true);
          });
      }

      // Tenta capturar o código de autorização automaticamente da URL
      function checkForAuthCode() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        if (code) {
          showMessage("Código de autorização detectado. Realizando troca...");
          trocarCodigoPorToken(code);
          // Limpa o parâmetro para não repetir a operação
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }

      // Adiciona os event listeners para os botões
      document.getElementById("btnLogin").addEventListener("click", iniciarAutenticacao);
      document.getElementById("btnTrocar").addEventListener("click", () => {
        const codeInput = document.getElementById("authCodeInput").value.trim();
        if (codeInput) {
          trocarCodigoPorToken(codeInput);
        } else {
          showMessage("Por favor, insira o código de autorização.", true);
        }
      });

      // Verifica se há um código na URL assim que a página carrega
      window.onload = checkForAuthCode;
    </script>
  </body>
</html>
